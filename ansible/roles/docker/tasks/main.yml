---
- name: Install prerequisites for Docker repository
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
    update_cache: true

- name: Ensure /etc/apt/keyrings exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Download Docker GPG key (ASCII)
  ansible.builtin.get_url:
    url: "{{ docker_gpg_key_url }}"
    dest: /tmp/docker.gpg
    mode: "0644"
  register: docker_gpg_download

- name: Check if Docker keyring already exists
  ansible.builtin.stat:
    path: "{{ docker_keyring_path }}"
  register: docker_keyring_stat

- name: Convert (dearmor) Docker GPG key to keyring
  ansible.builtin.command:
    cmd: "gpg --dearmor -o {{ docker_keyring_path }} /tmp/docker.gpg"
  when: docker_gpg_download.changed or (not docker_keyring_stat.stat.exists)
  notify: restart docker

- name: Set correct permissions on Docker keyring
  ansible.builtin.file:
    path: "{{ docker_keyring_path }}"
    mode: "0644"

- name: Set Docker APT architecture mapping
  ansible.builtin.set_fact:
    docker_apt_arch: "{{ {'x86_64':'amd64','aarch64':'arm64'}.get(ansible_architecture, ansible_architecture) }}"

- name: Add official Docker APT repository
  ansible.builtin.apt_repository:
    repo: "deb [arch={{ docker_apt_arch }} signed-by={{ docker_keyring_path }}] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
    filename: "{{ docker_repo_filename }}"

- name: Install Docker Engine packages
  ansible.builtin.apt:
    name: "{{ docker_packages }}"
    state: present
    update_cache: true
  notify: restart docker

- name: Ensure Docker service is enabled and running
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true

- name: Ensure docker group exists
  ansible.builtin.group:
    name: docker
    state: present

- name: Add user to docker group
  ansible.builtin.user:
    name: "{{ docker_user }}"
    groups: docker
    append: true

- name: Install Docker SDK for Python on target (for Ansible docker modules)
  ansible.builtin.apt:
    name: python3-docker
    state: present
